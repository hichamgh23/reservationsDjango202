{% extends "base.html" %}
{% load static %}

{% block title %}Réserver - {{ representation.show.title }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-dark text-white">
            <h2 class="mb-0">Détail de la commande</h2>
        </div>
        <div class="card-body p-4">
            <div class="mb-4">
                <h3>{{ representation.show.title }}</h3>
                <p class="mb-1"><i class="fa fa-map-marker"></i> <strong>Lieu :</strong> {{ representation.location.designation }}</p>
                
                {% if remaining_seats > 0 %}
                    <div class="alert alert-info">
                        Il reste <strong>{{ remaining_seats }}</strong> places disponibles pour cette séance.
                    </div>
                {% else %}
                    <div class="alert alert-danger">
                        <strong>Séance complète !</strong> Vous ne pouvez plus réserver.
                    </div>
                {% endif %}
            </div>

            <form action="{% url 'catalogue:book_representation' representation.id %}" method="post">
                {% csrf_token %}
                <table class="table table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Type</th>
                            <th>Prix Unitaire</th>
                            <th>Quantité</th>
                            <th class="text-right">Sous-total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Place Standard</td>
                            <td><span id="unit-price">{{ representation.show.price }}</span> €</td>
                            <td>
                                <input type="number" name="places" id="places" class="form-control" 
                                       value="1" min="1" max="{{ remaining_seats }}" 
                                       {% if remaining_seats <= 0 %}disabled{% endif %}>
                            </td>
                            <td class="text-right"><span id="subtotal-places">0.00</span> €</td>
                        </tr>
                        <tr class="table-secondary">
                            <td colspan="2">Frais administratifs fixes</td>
                            <td>1</td>
                            <td class="text-right">2,00 €</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-warning font-weight-bold">
                            <th colspan="3" class="text-right">TOTAL</th>
                            <th class="text-right"><span id="total-display">0.00</span> €</th>
                        </tr>
                    </tfoot>
                </table>

                <div class="mt-4 text-right">
                    <a href="{% url 'catalogue:show_detail' representation.show.id %}" class="btn btn-outline-secondary btn-lg">Annuler</a>
                    {% if remaining_seats > 0 %}
                        <button type="submit" class="btn btn-success btn-lg ml-2">Suivant</button>
                    {% else %}
                        <button type="button" class="btn btn-danger btn-lg ml-2" disabled>Complet</button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    $(document).ready(function() {
        const unitPrice = parseFloat("{{ representation.show.price }}".replace(',', '.'));
        const adminFees = 2.00;

        function update() {
            let qty = parseInt($('#places').val());
            if (isNaN(qty) || qty < 1) qty = 0;

            let sub = unitPrice * qty;
            let total = (qty > 0) ? (sub + adminFees) : 0;

            $('#subtotal-places').text(sub.toFixed(2).replace('.', ','));
            $('#total-display').text(total.toFixed(2).replace('.', ','));
        }

        $('#places').on('input change', update);
        update();
    });
</script>
{% endblock %}
